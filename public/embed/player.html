<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>StreamFlow Player</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,sans-serif;}
.player-wrap{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
video{width:100%;height:100%;background:#000;outline:none;}
.error-msg{color:#fff;text-align:center;padding:20px;font-size:16px;}
.error-msg h2{margin-bottom:8px;color:#0ea5e9;}
.error-msg p{color:#94a3b8;font-size:14px;}
.loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:12px;color:#fff;z-index:10;}
.spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,0.15);border-top-color:#0ea5e9;border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-size:13px;color:#94a3b8;}
.hidden{display:none;}
</style>
</head>
<body>
<div class="player-wrap">
  <div class="loading" id="loader">
    <div class="spinner"></div>
    <div class="loading-text">Загрузка потока...</div>
  </div>
  <video id="video" controls autoplay playsinline></video>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest/dist/hls.min.js"></script>
<script>
(function(){
  var params = {};
  var search = location.search.substring(1);
  if(search){
    var pairs = search.split("&");
    for(var i=0;i<pairs.length;i++){
      var kv = pairs[i].split("=");
      if(kv[0]) params[decodeURIComponent(kv[0])] = kv[1] ? decodeURIComponent(kv[1]) : "";
    }
  }
  
  var file = params["file"] || "";
  var loader = document.getElementById("loader");
  var video = document.getElementById("video");
  
  if(!file){
    loader.classList.add("hidden");
    document.querySelector(".player-wrap").innerHTML = '<div class="error-msg"><h2>StreamFlow</h2><p>Файл не указан. Вернитесь на главную и вставьте ссылку на поток.</p></div>';
    return;
  }
  
  var isHLS = file.indexOf(".m3u8") !== -1;
  
  function hideLoader(){
    loader.classList.add("hidden");
  }
  
  function showError(msg){
    hideLoader();
    document.querySelector(".player-wrap").innerHTML = '<div class="error-msg"><h2>Ошибка воспроизведения</h2><p>' + msg + '</p></div>';
  }
  
  if(isHLS){
    if(typeof Hls !== "undefined" && Hls.isSupported()){
      var hls = new Hls({
        maxBufferLength: 30,
        maxMaxBufferLength: 60,
        startLevel: -1,
        capLevelToPlayerSize: true,
        debug: false
      });
      hls.loadSource(file);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, function(event, data){
        hideLoader();
        video.play().catch(function(){});
      });
      hls.on(Hls.Events.ERROR, function(event, data){
        if(data.fatal){
          switch(data.type){
            case Hls.ErrorTypes.NETWORK_ERROR:
              showError("Сетевая ошибка. Проверьте ссылку на поток и подключение к интернету.");
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              hls.recoverMediaError();
              break;
            default:
              showError("Не удалось воспроизвести поток. Возможно, ссылка недействительна или поток недоступен.");
              hls.destroy();
              break;
          }
        }
      });
    } else if(video.canPlayType("application/vnd.apple.mpegurl")){
      // Native HLS support (Safari/iOS)
      video.src = file;
      video.addEventListener("loadedmetadata", function(){ hideLoader(); video.play().catch(function(){}); });
      video.addEventListener("error", function(){ showError("Не удалось воспроизвести поток."); });
    } else {
      showError("Ваш браузер не поддерживает воспроизведение HLS потоков.");
    }
  } else {
    // Direct video (mp4, webm, etc.)
    video.src = file;
    video.addEventListener("loadedmetadata", function(){ hideLoader(); video.play().catch(function(){}); });
    video.addEventListener("error", function(){ showError("Не удалось воспроизвести видео. Проверьте формат и ссылку."); });
  }
})();
</script>
</body>
</html>
