<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/gh/OinkTechLtd/cdnplayerjs@main/playerjs.js" type="text/javascript"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0e27;
      color: #fff;
    }

    .container {
      display: flex;
      height: 100%;
      gap: 0;
    }

    .playlist-sidebar {
      width: 280px;
      background: #0f1229;
      border-right: 1px solid #1a1f3a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .playlist-header {
      padding: 12px;
      border-bottom: 1px solid #1a1f3a;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      color: #7a8aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .playlist-items {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .playlist-item {
      padding: 10px 12px;
      border-bottom: 1px solid #1a1f3a;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      color: #a0afc0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .playlist-item:hover {
      background: #1a1f3a;
      color: #fff;
    }

    .playlist-item.active {
      background: #1e40af;
      color: #fff;
      font-weight: 600;
    }

    .playlist-items::-webkit-scrollbar {
      width: 6px;
    }

    .playlist-items::-webkit-scrollbar-track {
      background: transparent;
    }

    .playlist-items::-webkit-scrollbar-thumb {
      background: #3a4560;
      border-radius: 3px;
    }

    .player-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #playerjs {
      width: 100%;
      height: 100%;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7a8aaa;
      font-size: 14px;
      gap: 8px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #3a4560;
      border-top: 2px solid #1e40af;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .playlist-sidebar {
        width: 200px;
      }
    }

    @media (max-width: 480px) {
      .container {
        flex-direction: column;
      }

      .playlist-sidebar {
        width: 100%;
        height: auto;
        max-height: 25%;
        border-right: none;
        border-bottom: 1px solid #1a1f3a;
      }

      .player-container {
        flex: 1;
        min-height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="playlist-sidebar">
      <div class="playlist-header" id="playlistTitle">Плейлист</div>
      <div class="playlist-items" id="playlistItems"></div>
    </div>
    <div class="player-container">
      <div id="playerjs"></div>
    </div>
  </div>

  <script>
    const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
    const FALLBACK_PROXY = 'https://api.allorigins.win/raw?url=';

    let playlistData = [];
    let currentIndex = 0;
    let player = null;
    let loadedStreams = JSON.parse(localStorage.getItem('streamCache') || '{}');

    // Parse URL parameters
    function getUrlParams() {
      const params = {};
      const hash = location.href.substring(location.href.indexOf('?') + 1);
      const parts = hash.split('&');
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i].split('=');
        params[decodeURIComponent(part[0])] = decodeURIComponent(part[1] || '');
      }
      return params;
    }

    // Fetch with fallback proxies
    async function fetchWithFallback(url, isPlaylist = false) {
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: { 'Accept': isPlaylist ? 'text/plain' : 'application/octet-stream' }
        });
        if (response.ok) return response.text();
      } catch (e) {
        console.log('[fallback] Direct fetch failed, trying proxies');
      }

      // Try allorigins proxy (no CORS issues)
      try {
        const response = await fetch(FALLBACK_PROXY + encodeURIComponent(url), {
          method: 'GET'
        });
        if (response.ok) return response.text();
      } catch (e) {
        console.log('[fallback] allorigins proxy failed');
      }

      throw new Error('Failed to fetch: ' + url);
    }

    // Parse M3U playlist
    function parseM3U(content) {
      const lines = content.split('\n');
      const items = [];
      let currentItem = null;

      for (let line of lines) {
        line = line.trim();
        if (line.startsWith('#EXTINF:')) {
          const title = line.split(',').pop() || 'Unknown';
          currentItem = { title, url: '' };
        } else if (line && !line.startsWith('#') && currentItem) {
          currentItem.url = line.replace(/^\s+|\s+$/g, '');
          if (currentItem.url) {
            items.push(currentItem);
            currentItem = null;
          }
        }
      }

      return items;
    }

    // Load playlist
    async function loadPlaylist(playlistUrl) {
      try {
        const container = document.getElementById('playerjs');
        container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Загрузка плейлиста...</span></div>';

        const content = await fetchWithFallback(playlistUrl, true);
        playlistData = parseM3U(content);

        if (playlistData.length === 0) {
          container.innerHTML = '<div class="loading">Плейлист пуст или ошибка при загрузке</div>';
          return;
        }

        document.getElementById('playlistTitle').textContent = `${playlistData.length} каналов`;
        renderPlaylist();
        loadStream(0);
      } catch (error) {
        console.error('Playlist load error:', error);
        document.getElementById('playerjs').innerHTML = '<div class="loading">❌ Ошибка загрузки плейлиста</div>';
      }
    }

    // Render playlist items
    function renderPlaylist() {
      const container = document.getElementById('playlistItems');
      container.innerHTML = '';

      playlistData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `playlist-item ${index === currentIndex ? 'active' : ''}`;
        div.textContent = item.title;
        div.onclick = () => loadStream(index);
        container.appendChild(div);
      });
    }

    // Load and play stream
    async function loadStream(index) {
      currentIndex = index;
      const item = playlistData[index];

      // Update UI
      document.querySelectorAll('.playlist-item').forEach((el, i) => {
        el.classList.toggle('active', i === index);
      });

      const container = document.getElementById('playerjs');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Загрузка потока...</span></div>';

      try {
        // Try to load with fallback proxies
        let streamUrl = item.url;
        
        // Try direct access first
        try {
          const response = await fetch(streamUrl, { method: 'HEAD' });
          if (response.ok) {
            initializePlayer(streamUrl, item.title);
            loadedStreams[item.title] = streamUrl;
            localStorage.setItem('streamCache', JSON.stringify(loadedStreams));
            return;
          }
        } catch (e) {
          console.log('[stream] Direct access failed, using proxy');
        }

        // Try with proxy if direct failed
        const proxiedUrl = FALLBACK_PROXY + encodeURIComponent(streamUrl);
        initializePlayer(proxiedUrl, item.title);
        loadedStreams[item.title] = proxiedUrl;
        localStorage.setItem('streamCache', JSON.stringify(loadedStreams));
      } catch (error) {
        console.error('Stream load error:', error);
        
        // Try cached version if available
        if (loadedStreams[item.title]) {
          console.log('[fallback] Using cached stream');
          initializePlayer(loadedStreams[item.title], item.title);
        } else {
          container.innerHTML = '<div class="loading">❌ Не удалось загрузить поток. Попробуйте другой канал.</div>';
        }
      }
    }

    // Initialize PlayerJS
    function initializePlayer(streamUrl, title) {
      // Clear previous player
      const container = document.getElementById('playerjs');
      container.innerHTML = '';

      const config = {
        id: 'playerjs',
        file: streamUrl,
        title: title,
        poster: '',
        autoplay: true,
        controls: true,
        loop: false,
        muted: false,
        volume: 80,
        width: '100%',
        height: '100%'
      };

      player = new Playerjs(config);
    }

    // Load direct stream or playlist on init
    function init() {
      const params = getUrlParams();

      if (params.playlist) {
        // Load M3U playlist
        loadPlaylist(decodeURIComponent(params.playlist));
      } else if (params.file) {
        // Load single file
        document.querySelector('.playlist-sidebar').style.display = 'none';
        document.getElementById('playerjs').style.width = '100%';
        
        const config = {
          id: 'playerjs',
          file: decodeURIComponent(params.file),
          title: decodeURIComponent(params.title || 'Видео'),
          autoplay: true,
          controls: true,
          loop: false,
          volume: 80,
          width: '100%',
          height: '100%'
        };

        player = new Playerjs(config);
      } else {
        document.getElementById('playerjs').innerHTML = '<div class="loading">Параметр file или playlist не указан</div>';
      }
    }

    // Initialize on load
    window.addEventListener('load', init);
  </script>
</body>
</html>
